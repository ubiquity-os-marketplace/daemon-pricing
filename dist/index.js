import{createActionsPlugin as Tr}from"@ubiquity-os/plugin-sdk";import{LOG_LEVEL as kr}from"@ubiquity-os/ubiquity-os-logger";import{CONFIG_ORG_REPO as Xe}from"@ubiquity-os/plugin-sdk/constants";var O="chore: [skip ci] update labels configuration";async function z(e){let{octokit:r,payload:t,logger:i}=e,o=t.repository.owner?.login,n=t.repository.name,s=`heads/${t.repository.default_branch}`;if(!o)throw i.error("No owner was found in the repository, a commit / push action cannot be performed.",{payload:t});let m=(await r.rest.git.getRef({owner:o,repo:n,ref:s})).data.object.sha,u=(await r.rest.git.getCommit({owner:o,repo:n,commit_sha:m})).data.tree.sha,d=(await r.rest.git.createCommit({owner:o,repo:n,message:O,tree:u,parents:[m]})).data.sha,{data:c}=await r.rest.git.updateRef({owner:o,repo:n,ref:s,sha:d});i.info(`Pushed an empty commit to ${t.repository.html_url}`,{commitUrl:c.url})}async function Te(e,r){let t=e.payload.repository.owner?.login;if(!t)throw e.logger.error("No owner found in the repository!");return(await e.octokit.rest.repos.getCollaboratorPermissionLevel({owner:t,repo:e.payload.repository.name,username:r})).data.permission==="admin"}async function ke(e,r){if(!e.payload.organization)throw e.logger.error("No organization found in payload!");try{await e.octokit.rest.orgs.checkMembershipForUser({org:e.payload.organization.login,username:r})}catch{return!1}let{data:t}=await e.octokit.rest.orgs.getMembershipForUser({org:e.payload.organization.login,username:r});return t.role==="billing_manager"}function Oe(e){let{payload:r}=e;return r.sender?.type==="Bot"}async function b(e,r){return r?await Te(e,r)||Oe(e)?"admin":await ke(e,r)?"billing_manager":!1:!1}async function G(e){let r=e.payload.organization?.login;if(!r)throw e.logger.error("No organization found in payload!",{payload:e.payload});try{return(await e.octokit.rest.repos.listForOrg({org:r})).data.filter(i=>!i.archived&&!i.disabled&&!e.config.globalConfigUpdate?.excludeRepos.includes(i.name))}catch(t){throw e.logger.error("Listing org repos failed!",{err:t})}}async function W(e,r,t){try{return await e.octokit.paginate(e.octokit.rest.issues.listForRepo,{owner:r,repo:t})}catch(i){throw e.logger.error("Listing repo issues failed!",{err:i})}}function w(e){return e.eventName==="issues.labeled"||e.eventName==="issues.unlabeled"}function I(e){return e.eventName==="issues.opened"}function R(e){return"issue"in e.payload}function y(e){return e.eventName==="push"}import{CONFIG_FULL_PATH as Ie,DEV_CONFIG_FULL_PATH as Re}from"@ubiquity-os/plugin-sdk/constants";function H(e){let r=[];for(let t of e){if(t.modified?.length)for(let i of t.modified)r.push(i);if(t.added?.length)for(let i of t.added)r.push(i)}return r}var Ne="0000000000000000000000000000000000000000",Se=[Re,Ie];async function K(e){if(!y(e))return e.logger.debug("Not a push event"),!1;let{logger:r,payload:t}=e;if(t.before===Ne)return r.info("Skipping push events. A new branch was created"),!1;let i=H(t.commits);if(i&&i.length===0)return r.info("No files were changed in the commits, so no action is required."),!1;let o=!1;for(let n of Se)if(i.includes(n)){r.info(`${n} was modified or added in the commits`),o=!0;break}return o}async function Y(e){if(!y(e))return e.logger.debug("Not a push event"),!1;let{logger:r,payload:{repository:t,head_commit:i}}=e,o=i?.id,n;if(!o)throw new Error("No commit sha found");let s=t.owner?.login;if(!s)throw r.error("No owner found in the repository");try{n=await e.octokit.rest.repos.getCommit({owner:s,repo:t.name,ref:o,mediaType:{format:"diff"}})}catch(c){r.debug("Commit sha error.",{err:c})}if(!n)throw new Error("No commit data found");let m=n.data.split(`
`),l=/\+\s*collaboratorOnly:\s*(\S+)/,u=/-\s*collaboratorOnly:\s*(\S+)/,p=V(m,l),d=V(m,u);return!d&&!p&&r.error("No label changes found in the diff"),!!d?.length||!!p?.length}function V(e,r){let i=e?.find(o=>r.test(o))?.match(r);return i?i[1]:void 0}var v={default:"ededed",price:"1f883d"},j="No owner found in the repository!";async function N(e){let{payload:r,octokit:t}=e,i=r.repository.owner?.login;if(!i)throw e.logger.error(j);let o=await t.paginate(t.rest.issues.listLabelsForRepo,{owner:i,repo:r.repository.name,per_page:100});return e.logger.debug(`Fetching labels for repository ${r.repository.html_url}`,{owner:i,repo:r.repository.name,labels:o.map(n=>n.name)}),o.length>0?(await new Promise(n=>setTimeout(n,5e3)),o):[]}async function C(e,r,t="default",i){let o=e.payload,n=r.startsWith("Price: ")?v.price:v[t],s=o.repository.owner?.login;if(!s)throw e.logger.error(j);try{let a={owner:s,repo:o.repository.name,name:r,color:n,description:i};e.logger.debug("Trying to create label",{createLabelsOptions:a}),await e.octokit.rest.issues.createLabel(a)}catch(a){e.logger.error("Creating a label failed!",{err:a})}}async function P(e){let r=e.payload;if(!("issue"in r)||!r.issue)return;let t=r.issue.labels;if(!t)return;let i=t.filter(o=>o.name.toString().startsWith("Price: ")||o.name.toString().startsWith("Pricing: "));if(i.length)for(let o of i)try{await e.octokit.rest.issues.removeLabel({owner:r.repository.owner.login,repo:r.repository.name,issue_number:r.issue.number,name:o.name})}catch(n){if(n&&typeof n=="object"&&"status"in n&&n.status===404)e.logger.error(`Label [${o.name}] not found on issue ${r.issue.html_url}, ignoring.`,{err:n});else throw e.logger.error(`Removing label on issue ${r.issue.html_url} failed!`,{label:o,err:n})}}async function E(e,r){let t=e.payload;if(!("issue"in t)||!t.issue){e.logger.warn("No issue was found in the payload.",{event:e.eventName});return}try{await e.octokit.rest.issues.addLabels({owner:t.repository.owner.login,repo:t.repository.name,issue_number:t.issue.number,labels:[r]})}catch(i){throw e.logger.error("Adding a label to issue failed!",{err:i})}}async function S(e,r){let t=e.payload;if(!(!("issue"in t)||!t.issue))try{await e.octokit.rest.issues.removeLabel({owner:t.repository.owner.login,repo:t.repository.name,issue_number:t.issue.number,name:r})}catch(i){throw e.logger.error("Removing a label from an issue failed!",{err:i})}}function Ae(e){let r=e.map(s=>{let a=RegExp(/(\D*)(\d*\.?\d+)(\D*)/).exec(s.name);if(!a)throw new Error("Labels do not seem to contain any number value, please check your configuration.");return{prefix:a[1],number:a[2],suffix:a[3]}}),t=r.map(s=>s.prefix),i=r.map(s=>s.suffix),o=t.reduce((s,a)=>s===a?s:"",t[0]),n=i.reduce((s,a)=>s===a?s:"",i[0]);if(!o&&!n)throw new Error("No common prefixes or suffixes have been found for the label list, please check your configuration.");return`${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(\\d*\\.?\\d+)${n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`}function Me(e){return e.map(r=>{let t=RegExp(/\d*\.?\d+/).exec(r.name);return t?parseInt(t[0],10):null})}function L(e){if(Me(e).some(i=>i===null))throw new Error("Some tags seem to not have any number value, please check your configuration.");let t=Ae(e);return new RegExp(t,"i")}function q(e){let r=L(e);if(!r)throw new Error(`Could not determine the label pattern. Tags: ${JSON.stringify(e)}`);function t(n){let s=r?.exec(n);return s?parseInt(s[1],10):-1}let i=t(e[0].name),o=t(e[1].name);return i<o?1:-1}import X from"ms";var Ue={m:"minute",min:"minute",mins:"minute",minute:"minute",minutes:"minute",h:"hour",hr:"hour",hrs:"hour",hour:"hour",hours:"hour",d:"day",day:"day",days:"day",w:"week",wk:"week",wks:"week",week:"week",weeks:"week",mo:"month",mon:"month",mons:"month",month:"month",months:"month"},J={minute:{singular:"Minute",plural:"Minutes"},hour:{singular:"Hour",plural:"Hours"},day:{singular:"Day",plural:"Days"},week:{singular:"Week",plural:"Weeks"},month:{singular:"Month",plural:"Months"}};function Fe(e){let r=RegExp(/^Time:\s*<?\s*(.+)$/i).exec(e.trim());return r?r[1].trim():e.trim()}function De(e){let r=e.toLowerCase();return Ue[r]??null}function Z(e){let r=/(\d+(?:\.\d+)?)\s*([a-zA-Z]+)\b/.exec(e);if(!r)return null;let t=Number.parseFloat(r[1]);if(!Number.isFinite(t))return null;let i=De(r[2]);return i?{value:t,unit:i}:null}function $e(e){return Number.isInteger(e)?e.toString():Number(e.toFixed(2)).toString()}function _(e){if(!e)return null;let r=Fe(e);if(r=r.replace(/^</,"").trim(),!r)return null;if(/^\d+(\.\d+)?$/.test(r))return{value:Number.parseFloat(r),unit:"day"};let t=Z(r);if(t)return t;let i=X(r);if(typeof i=="number"&&i>0){let o=X(i,{long:!0});if(typeof o=="string")return Z(o)}return null}function h(e){return/^Time:/i.test(e.trim())?_(e):null}function x(e){return h(e)!==null}function M(e){let r=e.value===1?J[e.unit].singular:J[e.unit].plural;return`${$e(e.value)} ${r}`}function U(e){return`Time: ${M(e)}`}async function Q(e){if(I(e))return b(e,e.payload.sender?.login);if(!w(e))return e.logger.debug("Not an issue event"),!1;let{logger:r,payload:t}=e,{shouldFundContributorClosedIssue:i}=e.config;if(!t.label?.name)return r.debug("The label has no name."),!1;if(i)return r.info("Fund contributor closed issue is enabled for setting labels"),!0;if(t.sender?.type==="Bot")return r.info("Bot has full control over all labels"),!0;let o=t.sender?.login;if(!o)throw r.error("No sender found in the payload");let n=t.repository,s=await b(e,o),a=L(e.config.labels.priority),m=h(t.label.name)!==null,l=t.label?.name?.split(":");if(l.length<=1&&!m&&!a.test(t.label.name))return e.logger.debug("The label does not appear to be a recognized label.",{label:t.label}),!1;let u=l[0].toLowerCase();return s?(r.info("Admin and billing managers have full control over all labels",{repo:n.full_name,user:o,labelType:u}),!0):!1}import{Decimal as F}from"decimal.js";function ze(e,r,t,i){let o=i??e.config.basePriceMultiplier,n=new F(t).div(10);if(q(e.config.labels.priority)<0){let a=e.config.labels.priority.reduce((m,l)=>{let u=RegExp(/\d+/).exec(l.name);if(u!==null){let p=Number(u);if(p>m)return p}return m},0);n=new F(a-t).div(10)}return new F(o).mul(1e3).mul(r).mul(n).toDecimalPlaces(2).toString()}function ee(e,r,t){let i=e.logger,{labels:o}=e.config;if(!r||!t)throw i.error("Time or priority label is not defined");let n=o.priority.find(l=>l.name===t.name);if(!n)throw i.error("Priority label is not recognized");let s=T(e,r.name);if(s===null)throw i.error("Time value is not defined");let a=T(e,n.name);if(a===null)throw i.error("Priority value is not defined");return`Price: ${ze(e,s,a)} USD`}function T(e,r){if(L(e.config.labels.priority).test(r)){let n=r.match(/\d+(?:\.\d+)?/);return n?.length?Number.parseFloat(n[0]):null}let i=h(r);if(!i)return null;let o=i.value;switch(i.unit){case"minute":return o*.002;case"hour":return o*.125;case"day":return 1+(o-1)*.25;case"week":return o+1;case"month":return 5+(o-1)*8;default:return null}}async function re(e,r){if(r.filter(i=>i.name.toString().startsWith("Price:")).length)throw await P(e),e.logger.warn("Pricing is disabled on parent issues, so the price labels have been cleared.");if(e.eventName==="issues.labeled")throw e.logger.warn("Pricing is not supported on parent issues, no price will be set.")}function A(e,r){return r.sort((t,i)=>(T(e,t.name)||0)-(T(e,i.name)||0))}function te(e){return RegExp(/-\s+\[([ x])]\s+#\d+/).exec(e)}async function Ge(e){if(!w(e)){e.logger.debug("The event is not an issue label event, cannot remove unauthorized labels.");return}let r=e.payload.repository.owner?.login,t=e.payload.repository.name,i=e.payload.issue.number,o=e.payload.label?.name;if(o&&r)try{await e.octokit.rest.issues.removeLabel({owner:r,repo:t,issue_number:i,name:o}),e.logger.info("Removed unauthorized label from issue",{label:o})}catch(n){e.logger.error("Failed to remove unauthorized label from issue",{err:n,label:o})}}async function ie(e){if(!I(e)){e.logger.warn("Not an issue transfer event");return}let r=e.payload.issue,t=r.labels;if(!t?.length){e.logger.warn("No labels were found to calculate the issue's price.");return}await oe(e,t,r)}async function oe(e,r,t,i){let{payload:o,logger:n,config:s}=e;if(!o.repository.owner?.login){n.warn("No owner was found in the repository.");return}if(t.body&&te(t.body)){await re(e,r);return}if(!await Q(e)){e.eventName==="issues.labeled"&&e.payload.sender?.type!=="Bot"&&(await e.commentHandler.postComment(e,n.warn("You are not allowed to set labels.")),await Ge(e));return}if(i?.name.includes("Price: ")){n.info("This is setting the price label directly so skipping the rest of the action.");let l=r.filter(c=>c.name.includes("Price: ")),u=A(e,l);if(u.shift()?.name)for(let c of u)await e.octokit.rest.issues.removeLabel({owner:o.repository.owner?.login,repo:o.repository.name,issue_number:t.number,name:c.name});return}await D(e,r,s)}async function ne(e){if(!w(e)){e.logger.debug("Not an issue event");return}let r=e.logger,t=e.payload;if(!t.repository.owner?.login){r.error("No owner found in the repository");return}let o=t.issue.labels;if(!o){r.info("No labels to calculate price");return}await oe(e,o,t.issue,t.label)}async function D(e,r,t){let i=e.logger,o=r.map(u=>u.name),n=We(r,t),s=L(e.config.labels.priority),a=r.filter(u=>h(u.name)!==null||s.test(u.name)).length>=2;if(!n.time.length||!n.priority.length){let u=i.error("No recognized labels were found to set the price of this task.",{repo:e.payload.repository.html_url,recognizedLabels:n});e.eventName==="issues.labeled"&&a&&await e.commentHandler.postComment(e,u),await P(e);return}let m=He(e,n);if(!m.time||!m.priority){i.error("No label to calculate price",{repo:e.payload.repository.html_url});return}for(let u of n.priority)u.name!==m.time?.name&&await S(e,u.name);let l=ee(e,m.time,m.priority);l?(await Ke(e,{name:l,description:null},o),i.info("Skipping action...",{repo:e.payload.repository.html_url,targetPriceLabel:l})):(await P(e),i.info("Cleared all price labels because target price label is missing."))}function We(e,r){let t=e.filter(o=>h(o.name)!==null),i=e.filter(o=>r.labels.priority.some(n=>n.name===o.name));return{time:t,priority:i}}function He(e,r){let t=A(e,r.time).shift(),i=A(e,r.priority).shift();return{time:t,priority:i}}async function Ke(e,r,t){let{repository:i}=e.payload;i.name==="devpool-directory"&&(r.name=r.name.replace("Price: ","Pricing: ")),t.find(n=>n.includes(r.name))?await Ve(e,r.name):((await N(e)).filter(s=>s.name.includes(r.name)).length===0&&await C(e,r.name,"price"),await se(e,r.name))}async function Ve(e,r){let t=e.logger,i=await Ye(e);if(!i)return t.error("No labeled events found");if(i=i.filter(o=>"label"in o&&o.label.name.includes("Price")),!i.length)return t.error("No price labeled events found");i[i.length-1].actor?.type=="User"?t.info("Skipping... already exists"):await se(e,r)}async function se(e,r){await P(e),await E(e,r)}async function Ye(e){let r=await je(e);return r?r.filter(t=>t.event==="labeled"):null}async function je(e){if(!("issue"in e.payload)||!e.payload.issue){e.logger.debug("Not an issue event");return}try{return await e.octokit.paginate(e.octokit.rest.issues.listEvents,{owner:e.payload.repository.owner.login,repo:e.payload.repository.name,issue_number:e.payload.issue.number,per_page:100})}catch(r){return e.logger.error("Failed to fetch lists of events",{err:r}),[]}}var qe="No owner found in the repository!";async function k(e){let{logger:r}=e,t=e.payload.repository.owner?.login;if(!t)throw r.error(qe);let i=await N(e),o=i.filter(a=>a.name.startsWith("Price: ")&&a.color!==v.price);o.length>0&&(r.info("Incorrect color labels found, updating them",{incorrectColorPriceLabels:o.map(a=>a.name)}),await Promise.allSettled(o.map(a=>e.octokit.rest.issues.updateLabel({owner:t,repo:e.payload.repository.name,name:a.name,color:v.price}))),r.info("Updating incorrect color labels done"));let s=e.config.labels.priority.map(a=>a.name).filter(a=>!i.some(m=>m.name===a));s.length>0&&(r.info(`Missing priority labels found in ${e.payload.repository.html_url}, creating them`,{missingPriorityLabels:s}),await Promise.allSettled(s.map(a=>C(e,a,"default"))),r.info("Creating missing priority labels done"))}async function Je(e){if(!y(e))return e.logger.debug("Not a push event"),!1;let{payload:r,logger:t}=e,i=r.sender?.login,o=r.pusher?.name,n=await b(e,o),s=await b(e,i);return n||t.error("Pusher is not an admin or billing manager",{login:o}),s||t.error("Sender is not an admin or billing manager",{login:i}),!!(n&&s)}async function Ze(e){let{logger:r,config:{globalConfigUpdate:t}}=e,i=[],{repository:o}=e.payload;o.name===Xe?i.push(...(await G(e)).filter(n=>!t?.excludeRepos.includes(n.name))):i.push(e.payload.repository),r.info("Will send an empty commit to the following list of repositories",{repos:i.map(n=>n.html_url)});for(let n of i){let s={...e,payload:{repository:n}};try{await z(s)}catch(a){r.warn(`Could not push an empty commit to ${n.html_url}`,{err:a})}}}async function ae(e){if(!y(e)){e.logger.debug("Not a push event");return}let{logger:r}=e;if(!await Je(e)){r.error("Changes should be pushed and triggered by an admin or billing manager.");return}if((await K(e)||await Y(e))&&y(e)){await Ze(e);return}else if(e.payload.head_commit?.message!==O){r.info("The commit name does not match the label update commit message, won't update labels.",{url:e.payload.repository.html_url});return}let i=e.payload.repository;r.info(`Updating pricing labels in ${i.html_url}`);let o=i.owner?.login,n=i.name;if(!o)throw r.error("No owner was found in the payload.");await k(e);let s=await W(e,o,n);for(let a of s){let m={...e,payload:{...e.payload,issue:a}};await D(m,a.labels,m.config)}}import{createAppAuth as le}from"@octokit/auth-app";import{Octokit as me}from"@octokit/rest";import{customOctokit as xe}from"@ubiquity-os/plugin-sdk/octokit";var Qe=/^([\w-]+)\/([\w.-]+)@([\w./-]+)$/,ue="deep-estimate.yml";async function er(e,r,t){let{APP_ID:i,APP_PRIVATE_KEY:o}=e.env;if(!i||!o){let a=process.env.PLUGIN_GITHUB_TOKEN?.trim();return a?(e.logger.debug("APP_ID or APP_PRIVATE_KEY missing; using PLUGIN_GITHUB_TOKEN for workflow dispatch."),new me({auth:a})):(e.logger.debug("APP_ID or APP_PRIVATE_KEY is missing; using default Octokit instance for workflow dispatch."),e.octokit)}let s=await new xe({authStrategy:le,auth:{appId:i,privateKey:o}}).rest.apps.getRepoInstallation({owner:r,repo:t});return new me({authStrategy:le,auth:{appId:i,privateKey:o,installationId:s.data.id}})}function rr(e){let r=e.payload.repository;if(r?.full_name)return r.full_name;let t=r?.owner?.login??"",i=r?.name??"";return t&&i?`${t}/${i}`:""}function tr(e){let r=Qe.exec(e);if(!r)return null;let[,t,i,o]=r;return{owner:t,repo:i,ref:o}}function ir(){let e=process.env.GITHUB_REPOSITORY?.trim(),r=process.env.GITHUB_REF_NAME?.trim();if(!e||!r)return null;let[t,i]=e.split("/");return!t||!i?null:{owner:t,repo:i,ref:r}}async function pe(e,r){let{logger:t,env:i}=e;if(e.authToken.startsWith("gh")&&!e.ubiquityKernelToken){t.warn("Missing ubiquityKernelToken; skipping deep time estimate dispatch.");return}let o=(i.ACTION_REF?tr(i.ACTION_REF):null)??ir();if(!o){t.warn("No valid ACTION_REF or GitHub Actions ref found; skipping deep-estimate dispatch.",{actionRef:i.ACTION_REF,githubRepository:process.env.GITHUB_REPOSITORY,githubRefName:process.env.GITHUB_REF_NAME});return}let{owner:n,repo:s,ref:a}=o,m=rr(e),l="issue"in e.payload?e.payload.issue?.number:void 0;if(!m||!l){t.warn("Missing repository or issue number; skipping deep-estimate dispatch.",{targetRepo:m,issueNumber:l});return}let u={repo:m,issueNumber:String(l),authToken:e.authToken,ubiquityKernelToken:e.ubiquityKernelToken??"",installationId:String(e.payload.installation?.id??""),forceOverride:r.forceOverride?"true":"false",trigger:r.trigger,initiator:r.initiator??e.payload.sender?.login??""};await(await er(e,n,s)).rest.actions.createWorkflowDispatch({owner:n,repo:s,ref:a,workflow_id:ue,inputs:u}),t.info("Dispatched deep time estimate workflow.",{workflow:ue,targetRepo:m,issueNumber:l,trigger:r.trigger,forceOverride:r.forceOverride})}import{callLlm as or,sanitizeLlmResponse as nr}from"@ubiquity-os/plugin-sdk";var sr=["admin","owner","billing_manager"],ar=["write","member","collaborator","maintain"];function lr(e){return sr.includes(e.toLowerCase())}function mr(e){return ar.includes(e.toLowerCase())}function ur(e){return e=e.toLowerCase(),lr(e)?"admin":mr(e)?"collaborator":"contributor"}async function pr(e,r){let{octokit:t,logger:i}=e,o=e.payload.organization?.login,n=e.payload.repository.owner?.login;if(o)try{return await t.rest.orgs.getMembershipForUser({org:o,username:r}),!0}catch(m){i.error("Could not get user membership",{err:m})}if(!n)return i.warn("No owner was found in the repository, cannot determine the user's membership."),!1;let a=(await t.rest.repos.getCollaboratorPermissionLevel({username:r,owner:n,repo:e.payload.repository.name})).data.role_name?.toLowerCase();return i.info(`Retrieved the role for ${r}: ${a}`),ur(a)!=="contributor"}var cr=["contributor","author","collaborator","admin"];function ce(e){return cr.indexOf(e)}async function $(e,r){let t=e.payload.issue.user.login;return r===t?"author":await b(e,r)?"admin":await pr(e,r)?"collaborator":"contributor"}var dr=["30 minutes","2 hours","1 day","3 days","1 week","1 month"],de=4e3,fe=800,ge=10;function fr(e){return typeof e=="object"&&e!==null&&Symbol.asyncIterator in e}function gr(e){let t=nr(e).trim();if(!t)return"";if(t.startsWith("{"))try{let o=JSON.parse(t),n=String(o.duration??o.estimate??o.time??"").trim();if(n)return n}catch{}return t.split(/\r?\n/).find(o=>o.trim())?.trim()??""}function br(e,r){let t=e.trim();if(!t)throw r.warn("LLM returned an empty time estimate.");let i=t.replace(/[`*_]/g,"").trim(),o=_(i);if(o)return M(o);throw r.warn("LLM returned an invalid time estimate.",{estimate:e})}function yr(e){return(e??[]).map(r=>r.name).filter(r=>x(r))}function hr(e){let r=e.trim();return r?r.length<=fe?r:`${r.slice(0,fe)}...`:""}async function wr(e){let r=e.payload.issue,t=r.comments??0;if(!t)return[];let i=e.payload.repository.owner?.login;if(!i)return[];let o=Math.min(ge,100),n=Math.max(1,Math.ceil(t/o)),s=await e.octokit.rest.issues.listComments({owner:i,repo:e.payload.repository.name,issue_number:r.number,per_page:o,page:n}),a=e.eventName==="issue_comment.created"?e.payload.comment?.id:void 0,m=/^\s*\/time\b/i;return(s.data??[]).filter(l=>l.user?.type==="User").filter(l=>!a||l.id!==a).map(l=>({author:l.user?.login??"unknown",body:hr(String(l.body??""))})).filter(l=>l.body&&!m.test(l.body)).slice(-ge)}async function be(e){let{logger:r}=e,t=e.payload.issue,i=t.title?.trim()??"",o=t.body?.trim()??"",n=o.length>de?`${o.slice(0,de)}...`:o,s=dr.join(", "),a=[];try{a=await wr(e)}catch(c){r.warn("Failed to fetch recent human comments for time estimation.",{err:c})}let m=a.length?`Recent human comments (latest ${a.length}):
${a.map(c=>`- ${c.author}: ${c.body}`).join(`
`)}`:"",l=[`Issue title:
${i||"(missing)"}`,`Issue body:
${n||"(missing)"}`,m].filter(Boolean).join(`

`),u;try{u=await or({messages:[{role:"system",content:`You estimate effort for GitHub issues. Reply with a single duration using minutes, hours, days, weeks, or months. Use digits and one unit. No extra text. Examples: ${s}.`},{role:"user",content:l}],max_tokens:32,temperature:.2},e)}catch(c){throw r.warn("Failed to estimate time with LLM. Provide a duration like `/time 2 hours`.",{err:c})}if(fr(u))throw r.warn("LLM returned an unexpected streaming response.");let p=gr(u.choices?.[0]?.message?.content??""),d=br(p,r);return r.info("Estimated time input from LLM",{estimate:p,normalized:d}),d}async function Lr(e){let r=e.payload.repository.owner?.login,t=e.payload.repository.name,i=e.payload.issue.number;if(!r)return null;let s=(await e.octokit.paginate(e.octokit.rest.issues.listEvents,{owner:r,repo:t,issue_number:i,per_page:100})).filter(l=>l.event==="labeled"&&l.label?.name&&String(l.label.name).toLowerCase().startsWith("time:")).reverse()[0];if(!s)return null;let a=s.actor?.login;if(!a)return{user:void 0,rank:void 0};if(!(s.actor?.type==="Bot")){let l=await $(e,a);return{user:a,rank:l}}try{let l=await e.octokit.paginate(e.octokit.rest.issues.listComments,{owner:r,repo:t,issue_number:i,per_page:100}),u=s.created_at?new Date(s.created_at).getTime():Number.POSITIVE_INFINITY,p=/^\s*\/time\b/i,d=l.filter(c=>c.body&&p.test(c.body)&&(!c.created_at||new Date(c.created_at).getTime()<=u)).slice(-1)[0];if(d?.user?.login){let c=await $(e,d.user.login);return{user:d.user.login,rank:c}}}catch{}return{user:a,rank:"admin"}}async function ye(e,r){let t=e.payload.repository.owner?.login;if(!t)throw e.logger.warn("No owner was found in the payload.");if("issue"in e.payload&&e.payload.issue?.labels?.some(o=>o.name===r))return;(await e.octokit.paginate(e.octokit.rest.issues.listLabelsForRepo,{owner:t,repo:e.payload.repository.name,per_page:100})).some(o=>o.name===r)||await C(e,r,"default")}async function Cr(e,r){if(!R(e))throw e.logger.warn("The `/time` command can only be used in issue comments.");let t=e,{payload:i}=e,o=i.sender.login,n=i.issue.labels.map(p=>p.name),s=n.filter(p=>p.toLowerCase().startsWith("time:"));async function a(){if(s.length===0)return;let p=await $(t,o);if(!(p==="admin"||p==="collaborator")){if(p==="author"){let d=await Lr(t);if(d?.user&&d.user===o||d?.rank!==void 0&&ce("author")>ce(d.rank))return;throw e.logger.warn("Insufficient permissions to change the time estimate.",{reason:"author-higher-rank",sender:o,senderRank:p,lastSetter:d?.user,lastSetterRank:d?.rank,existingTimeLabels:s,requestedTimeInput:r})}throw e.logger.warn("Insufficient permissions to change the time estimate.",{reason:"contributor-restriction",sender:o,senderRank:p,existingTimeLabels:s,requestedTimeInput:r})}}await a();let m=_(r);if(!m)throw e.logger.warn(`The provided time \`${r}\` is invalid.`,{input:r});let l=U(m),u=n.filter(p=>p.toLowerCase().startsWith("time:"));for(let p of u)await S(t,p);await ye(t,l),await E(t,l)}async function he(e){let{logger:r}=e,t=e.payload.issue,i=yr(t.labels);if(i.length>0){r.info("Skipping time estimation because a time label already exists.",{labels:i});return}try{let o=await be(e),n=_(o);if(!n)throw r.warn("LLM returned an invalid time estimate.",{estimate:o});let s=U(n);await ye(e,s),await E(e,s),r.info("Added estimated time label to new issue.",{timeLabel:s,estimate:o})}catch(o){r.warn("Failed to auto-estimate a time label for the new issue.",{err:o})}}async function we(e){let{comment:r}=e.payload,t=r.body.trim().split(" ")[0].replace("/","");if(t!=="time"){e.logger.warn(`The command ${t} is not supported.`);return}let n=(typeof e.command?.parameters?.duration=="string"?e.command.parameters.duration.trim():"")||r.body.replace(`/${t}`,"").trim()||await be(e);await Cr(e,n)}function Pr(e){return/^\s*\/time\b/i.test(e??"")}async function Le(e,r,t){try{await pe(e,r)}catch(i){e.logger.warn(t,{err:i})}}async function vr(e){!Pe()||!R(e)||Pr(e.payload.comment?.body)&&(await we(e),await Le(e,{trigger:"issue_comment.created",forceOverride:!0,initiator:e.payload.sender?.login},"Failed to dispatch deep time estimate after /time."))}async function Er(e){B()&&(await k(e),await he(e),await Le(e,{trigger:"issues.opened",forceOverride:!1,initiator:e.payload.sender?.login},"Failed to dispatch deep time estimate for new issue."),await ie(e))}function Ce(){return process.env.NODE_ENV==="local"}function B(){return Ce()||!!process.env.GITHUB_ACTIONS}function Pe(){return Ce()||!process.env.GITHUB_ACTIONS}async function ve(e){let{eventName:r,logger:t}=e;switch(r){case"issue_comment.created":await vr(e);break;case"issues.opened":{await Er(e);break}case"repository.created":B()&&await k(e);break;case"issues.labeled":case"issues.unlabeled":w(e)&&Pe()&&await ne(e);break;case"push":B()&&await ae(e);break;default:t.error(`Event ${r} is not supported`)}return{message:"OK"}}import{Type as f}from"@sinclair/typebox";import{LOG_LEVEL as _r}from"@ubiquity-os/ubiquity-os-logger";var Ee=f.Object({LOG_LEVEL:f.Optional(f.Enum(_r)),KERNEL_PUBLIC_KEY:f.Optional(f.String()),ACTION_REF:f.Optional(f.String()),APP_ID:f.Optional(f.String()),APP_PRIVATE_KEY:f.Optional(f.String()),APP_INSTALLATION_ID:f.Optional(f.String())});import{Type as g}from"@sinclair/typebox";var _e=g.Object({globalConfigUpdate:g.Optional(g.Object({excludeRepos:g.Array(g.String(),{examples:["repo-name","no-owner-required"],description:"List of repositories to exclude from being updated"})},{description:"Updates all price labels across all tasks based on `baseRateMultiplier` changes within the config file."})),labels:g.Object({priority:g.Array(g.Object({name:g.String({examples:["Priority: 1 (Normal)","Priority: 5 (Emergency)"],description:"The display name of the label representing task priority"}),collaboratorOnly:g.Boolean({default:!1,description:"Whether the task is only available for collaborators to be assigned"})}),{minItems:1,default:[{name:"Priority: 0 (Regression)",collaboratorOnly:!1},{name:"Priority: 1 (Normal)",collaboratorOnly:!1},{name:"Priority: 2 (Medium)",collaboratorOnly:!1},{name:"Priority: 3 (High)",collaboratorOnly:!1},{name:"Priority: 4 (Urgent)",collaboratorOnly:!1},{name:"Priority: 5 (Emergency)",collaboratorOnly:!1}]})},{default:{}}),basePriceMultiplier:g.Number({examples:[1.5],default:1,description:"The base price multiplier for all tasks"}),shouldFundContributorClosedIssue:g.Boolean({default:!1,description:"Whether to allow funding contributor closed issues"})},{default:{}});Tr(e=>ve(e),{envSchema:Ee,postCommentOnError:!0,settingsSchema:_e,logLevel:process.env.LOG_LEVEL||kr.INFO,kernelPublicKey:process.env.KERNEL_PUBLIC_KEY,bypassSignatureVerification:process.env.NODE_ENV==="local"}).catch(console.error);
